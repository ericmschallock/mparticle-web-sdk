name: Pre-release SDK


on:
  pull_request
    # workflow_dispatch:
    #     inputs:
    #         dryRun:
    #             description: 'Do a dry run to preview instead of a real release [true/false]'
    #             required: true
    #             default: 'true'
    #         release-order:
    #             description: 'Which Phase are you releaseing? [release-order-a/release-order-b/release-order-c]'
    #             required: true

jobs:
    # SDK release is done from master branch.
    # confirm-public-repo-master-branch:
    #     name: 'Confirm release is run from public/master branch'
    #     uses: mParticle/mparticle-workflows/.github/workflows/sdk-release-repo-branch-check.yml@main

    # TODO: Break this out into a reusable job
    build-bundle:
        name: Build Distribution Bundle
        runs-on: ubuntu-latest
        # needs: confirm-public-repo-master-branch
        steps:
            - name: Checkout
              uses: actions/checkout@v3
              with:
                    ref: development
            
            - name: Update your package.json with an npm pre-release version
              id: pre-release-version
              uses: adobe/update-prerelease-npm-version@v1.0.0
              with:
                pre-release-tag: 'pre-release'
            
            - name: Check Package.json
              run: cat package.json

            - name: NPM install
              uses: actions/setup-node@v3
              with:
                    node-version: 16.x

            - name: Run NPM CI
              run: npm ci

            - name: Lint with ESLint
              run: npm run lint

            - name: Lint with Prettier
              run: npm run prettier

            - name: Run Build IIFE
              run: npm run build:iife

            - name: Display Bundle Diff, but Fancy!
              run: git diff --unified=3 dist/mparticle.js | npx diff-so-fancy

            - name: Archive npm failure logs
              uses: actions/upload-artifact@v2
              if: failure()
              with:
                    name: npm-logs
                    path: ~/.npm/_logs